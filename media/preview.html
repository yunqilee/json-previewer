<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; style-src 'unsafe-inline' {{cspSource}}; script-src 'nonce-{{nonce}}';"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JSON Table Preview</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        padding: 12px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        margin-bottom: 8px;
      }

      input[type="search"] {
        width: 180px;
        padding: 4px 6px;
        font-size: 13px;
      }

      button {
        padding: 4px 8px;
        font-size: 12px;
        white-space: nowrap;
      }

      .meta {
        margin-left: auto;
        opacity: 0.7;
        font-size: 12px;
      }
      .wrap {
        overflow: auto;
        border: 1px solid rgba(127, 127, 127, 0.3);
        max-height: 80vh;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
      }
      th,
      td {
        border: 1px solid rgba(127, 127, 127, 0.3);
        padding: 6px 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      th {
        position: sticky;
        top: 0;
        background: rgba(127, 127, 127, 0.15);
      }
      tbody tr:nth-child(odd) {
        background: rgba(127, 127, 127, 0.06);
      }
      button {
        padding: 6px 10px;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <input id="search" type="search" placeholder="Search in any cell..." />
      <button id="exportCsv">Export CSV (Current View)</button>
      <button id="exportAll">Export CSV (All Rows)</button>
      <span class="meta" id="meta"
        >{{rowCount}} / {{rowCount}} rows · {{colCount}} columns</span
      >
    </div>

    <div class="wrap">
      <table>
        <thead>
          <tr id="thead">
            {{thead}}
          </tr>
        </thead>
        <tbody id="tbody">
          {{tbody}}
        </tbody>
      </table>
    </div>

    <script nonce="{{nonce}}">
      const vscode = acquireVsCodeApi();

      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");
      const meta = document.getElementById("meta");
      const input = document.getElementById("search");
      const btnExport = document.getElementById("exportCsv");
      const btnExportAll = document.getElementById("exportAll");

      if (!thead || !tbody) {
        console.error("thead/tbody not found");
      }

      const allRows = Array.from(tbody.querySelectorAll("tr"));
      const total = allRows.length;

      function applyFilter() {
        const q = input.value.trim().toLowerCase();
        let visible = 0;

        if (!q) {
          for (const tr of allRows) {
            tr.style.display = "";
          }
          visible = total;
        } else {
          for (const tr of allRows) {
            const text = tr.textContent?.toLowerCase() ?? "";
            const show = text.includes(q);
            tr.style.display = show ? "" : "none";
            if (show) visible++;
          }
        }
        meta.textContent = `${visible} / ${total} rows · {{colCount}} columns`;
      }

      // CSV helpers
      function csvEscape(value) {
        const s = value == null ? "" : String(value);
        return /[",\n]/.test(s) ? `"${s.replaceAll('"', '""')}"` : s;
      }
      function collectHeaders() {
        return Array.from(thead.querySelectorAll("th")).map(
          (th) => th.textContent ?? ""
        );
      }
      function collectRowCells(tr) {
        return Array.from(tr.querySelectorAll("td")).map(
          (td) => td.textContent ?? ""
        );
      }
      function collectVisibleRows() {
        return allRows.filter((tr) => tr.style.display !== "none");
      }
      function buildCsv(rowsToExport) {
        const headers = collectHeaders();
        const lines = [];
        lines.push(headers.map(csvEscape).join(","));
        for (const tr of rowsToExport) {
          lines.push(collectRowCells(tr).map(csvEscape).join(","));
        }
        // Add BOM for Excel compatibility
        return "\uFEFF" + lines.join("\n");
      }

      function requestSaveCsv(content, filename) {
        vscode.postMessage({ type: "downloadCSV", filename, content });
      }

      btnExport.addEventListener("click", () => {
        const rowsToExport = collectVisibleRows();
        const csv = buildCsv(rowsToExport);
        const ts = new Date().toISOString().replace(/[:.]/g, "-");
        requestSaveCsv(csv, `table-${ts}.csv`);
      });

      btnExportAll.addEventListener("click", () => {
        const csv = buildCsv(allRows);
        const ts = new Date().toISOString().replace(/[:.]/g, "-");
        requestSaveCsv(csv, `table-all-${ts}.csv`);
      });

      let timer;
      input.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(applyFilter, 120);
      });

      applyFilter();
    </script>
  </body>
</html>
